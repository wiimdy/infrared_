# Staking Contracts - Infrared Protocol

The `staking` folder in the Infrared Protocol provides contracts for liquid staking of BERA (Berachain's native gas token). The system enables users to stake their BERA and receive iBERA tokens while participating in Berachain's consensus mechanism through Infrared's managed validators.

---

## Concepts

### Liquid Staking Mechanism

The liquid staking system provides a way to stake BERA (native gas token) while maintaining liquidity through iBERA tokens. This mechanism is managed through a set of specialized contracts that handle deposits, withdrawals, and the claiming process, ensuring safe and efficient operations.

### Queue-based Operations

The protocol implements a queue-based system for both deposits and withdrawals to manage validator operations efficiently:

- **Deposit Queue**: Manages incoming BERA deposits through `IBERADepositor`, ensuring proper validator stake distribution
- **Withdrawal Queue**: Handles BERA withdrawal requests through `IBERAWithdrawor`, coordinating unstaking from validators
- **Claim System**: Provides secure BERA claiming through `IBERAClaimor` after withdrawal processing

### Fee Management

The protocol captures value from two primary sources:
- **Priority Fees & MEV**: Captured by validators during block production and received by `IBERAFeeReceivor`
- **Protocol Fees**: Charged on deposits and withdrawals to sustain protocol operations
- **Autocompounding**: Automatically reinvests collected fees to enhance staker yields

---

## Key Actors

1. **Staker**: Users who deposit BERA into the protocol, receiving iBERA tokens in return. They can burn iBERA to withdraw their BERA when desired.

2. **Keeper**: Trusted actor responsible for:
   - Processing deposit and withdrawal queues
   - Managing validator operations
   - Executing fee collection and distribution

3. **Protocol Governor**: Controls protocol parameters and can:
   - Update fee rates
   - Configure minimum amounts
   - Manage protocol settings

4. **Validator**: Produces blocks and generates priority fees & MEV, which flow to the `IBERAFeeReceivor` contract.

---

## Core Contracts

### 1. `IBERA.sol`

Primary contract managing the liquid staking system, coordinating between depositors, withdrawors, and fee collection.

- **Liquid Staking Token**: Mints and burns iBERA tokens representing staked BERA positions
- **Stake Management**: Tracks validator stakes and manages deposit/withdrawal coordination
- **Fee Configuration**: Sets and updates protocol fee parameters
- **Autocompounding**: Manages the reinvestment of collected fees into the staking pool

### 2. `IBERADepositor.sol`

Handles the secure queueing and execution of BERA deposits to Berachain's native staking system.

- **Queue Management**: Maintains ordered deposit requests with associated fees
- **Deposit Execution**: Interacts with Berachain's deposit precompile
- **Validator Distribution**: Coordinates deposit distribution across protocol validators

### 3. `IBERAWithdrawor.sol`

Manages the withdrawal process from Berachain's native staking system.

- **Withdrawal Queueing**: Orders and tracks withdrawal requests
- **Validator Interaction**: Manages withdrawal requests from protocol validators
- **Rebalancing**: Handles stake rebalancing between validators during withdrawals
- **Processing**: Coordinates with `IBERAClaimor` for final user withdrawals

### 4. `IBERAClaimor.sol`

Provides secure claiming mechanism for processed withdrawals.

- **Claim Tracking**: Maintains user claim records
- **Secure Withdrawals**: Ensures safe BERA transfer to withdrawing users
- **Batching**: Enables efficient processing of multiple claims

### 5. `IBERAFeeReceivor.sol`

Collects and manages priority fees and MEV generated by protocol validators.

- **Fee Collection**: Receives priority fees and MEV from block production
- **Distribution**: Splits fees between protocol treasury and autocompounding
- **Sweeping**: Periodically processes accumulated fees into the protocol

---

## Flow of Funds

1. **Deposit Flow**:
   - User deposits BERA → `IBERA` contract
   - `IBERADepositor` queues deposit
   - Keeper executes deposit to Berachain staking
   - User receives iBERA tokens

2. **Withdrawal Flow**:
   - User burns iBERA → `IBERA` contract
   - `IBERAWithdrawor` queues withdrawal
   - Keeper processes withdrawal from validators
   - `IBERAClaimor` enables BERA claim
   - User claims BERA

3. **Fee Flow**:
   - Validators generate priority fees & MEV
   - `IBERAFeeReceivor` collects rewards
   - Fees split between treasury and autocompound
   - Autocompounded portion reinvested into protocol

This system ensures efficient management of native BERA staking while providing liquidity through iBERA tokens and capturing validator rewards for protocol participants.